# 如何在Ubuntu 16.04上添加交换空间

### 介绍

提高服务器响应速度和防范应用程序内存不足错误的最简单方法之一是添加一些交换空间。在本指南中，我们将介绍如何将交换文件添加到Ubuntu 16.04服务器。

警告

虽然交换通常建议用于使用传统旋转硬盘驱动器的系统，但使用与SSD交换可能会导致随着时间的推移硬件退化问题。由于此考虑，我们不建议在DigitalOcean或任何其他使用SSD存储的供应商上启用交换。这样做会影响到您和您的邻居的底层硬件的可靠性。本指南是作为可能在其他地方使用旋转磁盘系统的用户的参考。如果您需要提高DigitalOcean服务器的性能，我们建议升级您的Droplet。这将导致更好的结果，并会降低可能影响您的服务的硬件问题。

## 什么是Swap？

**交换**是硬盘上的一个区域，它被指定为操作系统可以临时存储数据的地方，而这些数据不能再保存在RAM中。基本上，这使您能够增加服务器在工作“内存”中保留的信息量，并提供一些注意事项。主要在RAM中没有足够空间容纳正在使用的应用程序数据时，将使用硬盘驱动器上的交换空间。

写入磁盘的信息将比保存在RAM中的信息慢得多，但操作系统更愿意将应用程序数据保存在内存中，并使用交换来处理旧数据。总体而言，将系统内存空间用尽时的交换空间可能是一个很好的安全系统，可防范带有非SSD存储系统的内存不足情况。

## 检查系统的交换信息

在开始之前，我们可以检查系统是否已经有一些可用的交换空间。有可能有多个交换文件或交换分区，但通常一个应该就足够了。

我们可以通过键入以下命令来查看系统是否有任何配置交换：

```
sudo swapon --show
```

如果您没有取回任何输出，这意味着您的系统当前没有可用的交换空间。

您可以使用该`free`实用程序验证是否没有活动交换：

```
free -h
```

```
Output              total        used        free      shared  buff/cache   available
Mem:           488M         36M        104M        652K        348M        426M
Swap:            0B          0B          0B
```

正如您在输出的“交换”行中所看到的那样，系统上没有交换处于活动状态。

## 检查硬盘驱动器分区上的可用空间

为swap分配空间的最常见方式是使用专门用于该任务的单独分区。但是，改变分区方案并不总是可能的。我们可以轻松地创建驻留在现有分区上的交换文件。

在我们这样做之前，我们应该通过键入以下命令来检查当前磁盘使用情况

```
df -h
```

```
OutputFilesystem      Size  Used Avail Use% Mounted on
udev            238M     0  238M   0% /dev
tmpfs            49M  624K   49M   2% /run
/dev/vda1        20G  1.1G   18G   6% /
tmpfs           245M     0  245M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           245M     0  245M   0% /sys/fs/cgroup
tmpfs            49M     0   49M   0% /run/user/1001
```

下面的设备`/dev`是我们的磁盘在这种情况下。在这个例子中我们有足够的可用空间（仅使用了1.1G）。您的使用情况可能会有所不同。

尽管对于交换空间的适当大小有很多意见，但这取决于您的个人偏好和应用程序要求。一般来说，等于或者是系统内存量的两倍是一个很好的起点。另一个很好的经验法则是，如果您只是将它用作RAM备用，则任何超过4G的交换可能都是不必要的。

## 创建一个交换文件

现在我们知道了我们可用的硬盘空间，我们可以在我们的文件系统中创建一个交换文件。我们将创建一个我们想要`swapfile`在根（/）目录中调用的交换大小的文件。

创建交换文件的最佳方式是使用该`fallocate`程序。该命令立即创建一个预分配大小的文件。

由于我们示例中的服务器具有512MB的RAM，因此我们将在本指南中创建1 GB的文件。调整此设置以满足您自己的服务器的需求：

```
sudo fallocate -l 1G /swapfile
```

我们可以通过键入来验证是否保留了正确的空间量：

```
ls -lh /swapfile
```

```
-rw-r--r-- 1 root root 1.0G Apr 25 11:14 /swapfile
```

我们的文件已经创建了正确的空间。

## 启用交换文件

现在我们有一个可用的正确大小的文件，我们需要将其转换为交换空间。

首先，我们需要锁定文件的权限，以便只有具有`root`权限的用户才能读取内容。这可以防止普通用户能够访问该文件，这会产生重大的安全隐患。

只能`root`通过输入以下内容来访问该文件：

```
sudo chmod 600 /swapfile
```

键入以下内容验证权限是否更改

```
ls -lh /swapfile
```

```
Output-rw------- 1 root root 1.0G Apr 25 11:14 /swapfile
```

如您所见，只有root用户启用了读写标志。

我们现在可以通过输入以下内容将文件标记为交换空间

```
sudo mkswap /swapfile
```

```
OutputSetting up swapspace version 1, size = 1024 MiB (1073737728 bytes)
no label, UUID=6e965805-2ab9-450f-aed6-577e74089dbf
```

在标记文件后，我们可以启用交换文件，让我们的系统开始使用它：

```
sudo swapon /swapfile
```

我们可以通过输入以下内容验证交换是否可用：

```
sudo swapon --show
```

```
OutputNAME      TYPE  SIZE USED PRIO
/swapfile file 1024M   0B   -1
```

我们可以`free`再次检查实用程序的输出以证实我们的发现：

```
free -h
```

```
Output              total        used        free      shared  buff/cache   available
Mem:           488M         37M         96M        652K        354M        425M
Swap:          1.0G          0B        1.0G
```

我们的交换已成功建立，我们的操作系统将根据需要开始使用它。

## 使交换文件永久

我们最近的更改已启用当前会话的交换文件。但是，如果我们重新启动，服务器将不会自动保留交换设置。我们可以通过将交换文件添加到我们的`/etc/fstab`文件来改变这一点。

`/etc/fstab`在出现任何问题时备份文件：

```
sudo cp /etc/fstab /etc/fstab.bak
```

您可以`/etc/fstab`通过输入以下内容将交换文件信息添加到文件末尾：

```
echo '/swapfile none swap sw 0 0' | sudo tee -a /etc/fstab
```

## 调整你的交换设置

在处理交换时，可以配置几个选项，这些选项会影响系统的性能。

### 调整Swappiness属性

该`swappiness`参数配置您的系统将数据从RAM交换到交换空间的频率。这是介于0和100之间的值，表示百分比。

如果值接近零，内核将不会将数据交换到磁盘，除非绝对必要。请记住，与交换文件的交互是“昂贵的”，因为它们花费的时间比与RAM的交互更长，并且会导致性能显着下降。告诉系统不要太依赖交换通常会使系统更快。

接近100的值将尝试将更多的数据放入交换中以努力保持更多的RAM空间。根据您的应用程序的内存配置文件或您使用的服务器，在某些情况下可能会更好。

通过输入以下内容我们可以看到当前的swappiness值：

```
cat /proc/sys/vm/swappiness
```

```
Output60
```

对于桌面，60的swappiness设置并不是一个坏的值。对于服务器，您可能希望将其移近0。

我们可以使用该`sysctl`命令将swappiness设置为不同的值。

例如，要将swappiness设置为10，我们可以键入：

```
sudo sysctl vm.swappiness=10
```

```
Outputvm.swappiness = 10
```

该设置将持续到下一次重新启动。我们可以在重启时自动设置该值，方法是将该行添加到我们的`/etc/sysctl.conf`文件中：

```
sudo nano /etc/sysctl.conf
```

在底部，您可以添加：

/etc/sysctl.conf中

```
vm.swappiness=10
```

完成后保存并关闭文件。

### 调整缓存压力设置

您可能想要修改的另一个相关值是`vfs_cache_pressure`。此设置配置系统将选择多少数据缓存inode和dentry信息。

基本上，这是访问有关文件系统的数据。这通常是非常昂贵的查找和频繁请求，所以对于您的系统来说缓存是一件很棒的事情。您可以通过`proc`再次查询文件系统来查看当前值：

```
cat /proc/sys/vm/vfs_cache_pressure
```

```
Output100
```

正如目前配置的那样，我们的系统太快地从缓存中删除索引节点信息。通过输入以下内容，我们可以将其设置为更保守的设置，如50：

```
sudo sysctl vm.vfs_cache_pressure=50
```

```
Outputvm.vfs_cache_pressure = 50
```

再次，这只对我们目前的会议有效。我们可以通过将它添加到我们的配置文件中来改变它，就像我们使用我们的swappiness设置一样：

```
sudo nano /etc/sysctl.conf
```

在底部，添加指定您的新值的行：

/etc/sysctl.conf中

```
vm.vfs_cache_pressure=50
```

完成后保存并关闭文件。

## 结论

遵循本指南中的步骤将为您带来一些喘息的空间，否则会导致内存不足的例外。交换空间在避免这些常见问题方面可能非常有用。

如果您遇到OOM（内存不足）错误，或者如果您发现系统无法使用所需的应用程序，则最佳解决方案是优化应用程序配置或升级服务器。